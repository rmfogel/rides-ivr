# שיפורים בדף "הנסיעות שלי"

## תיאור השינויים

בוצעו שני שיפורים מרכזיים בדף ניהול הנסיעות (`my-rides.html`):

### 1. סימון נסיעות שעבר זמנן 🕒

### 1. סימון נסיעות שעבר זמנן 🕒

#### Backend (ללא צורך בשינויים)
הלוגיקה מתבצעת בצד הלקוח (Client-side)

#### Frontend
- **פונקציה חדשה**: `isPastRide(date, time)` - בודקת אם נסיעה עברה לפי תאריך ושעת יציאה
- **פונקציה חדשה**: `isPastRequest(date, latestTime)` - בודקת אם בקשת נסיעה עברה לפי תאריך והשעה המאוחרת ביותר
- **עיצוב**: 
  - CSS class חדש: `.past-ride` - מעמעם את הנסיעה (opacity: 0.6) ומשנה רקע לאפור
  - CSS class חדש: `.status-past` - תג סטטוס אפור עם הטקסט "עבר זמנה"
  - הכיוון והפרטים משתנים לצבע אפור (#757575)

### 2. הצגת הקצאות (Allocated Matches) 🤝

**חשוב להבין**: המערכת **מחליטה אוטומטית** על ההקצאות ברגע יצירת ההצעה/בקשה. 
אין צורך באישור משני הצדדים - ההחלטה נלקחת **על ידי המערכת** בזמן אמת.

#### Backend - Endpoints חדשים

##### `GET /api/rides/offer/:id/matches`
- **תיאור**: מחזיר את כל ההקצאות הפעילות של הצעת נסיעה ספציפית
- **פרמטרים**: 
  - `id` (path) - מזהה ההצעה
  - `phone` (query) - מספר טלפון לאימות זהות
- **סינון**: מחזיר **רק** matches עם status: `pending`, `notified`, `connected`, `accepted`
- **לא מחזיר**: matches עם status: `declined`, `cancelled`
- **החזרה**: מערך של matches עם פרטי הבקשות המלאים
- **אבטחה**: אימות שהמשתמש הוא בעלים של ההצעה
- **קבצים**: `server/src/routes/offer-ride.js`

##### `GET /api/rides/request/:id/matches`
- **תיאור**: מחזיר את כל ההקצאות הפעילות של בקשת נסיעה ספציפית
- **פרמטרים**: 
  - `id` (path) - מזהה הבקשה
  - `phone` (query) - מספר טלפון לאימות זהות
- **סינון**: מחזיר **רק** matches עם status: `pending`, `notified`, `connected`, `accepted`
- **לא מחזיר**: matches עם status: `declined`, `cancelled`
- **החזרה**: מערך של matches עם פרטי ההצעות המלאים
- **אבטחה**: אימות שהמשתמש הוא בעלים של הבקשה
- **קבצים**: `server/src/routes/request-ride.js`

**מבנה Match שמוחזר:**
```json
{
  "id": "match_id",
  "status": "pending|notified|connected|accepted|declined",
  "created_at": "2025-11-04T10:00:00Z",
  "allocated_male": 2,
  "allocated_female": 1,
  "allocated_anygender": 0,
  "allocated_couples": 0,
  "request": { /* פרטי בקשה מלאים */ },
  "offer": { /* פרטי הצעה מלאים */ }
}
```

#### Frontend - Modal להצגת הקצאות

##### כפתורים בממשק
- **להצעות (נהגים)**: "👥 מי נוסע איתי?"
- **לבקשות (נוסעים)**: "🚗 איך אני נוסע?"
- **CSS class**: `.btn-matches` - כפתור כחול
- **מיקום**: מופיע לכל נסיעה (הצעה או בקשה)

##### HTML
- **אלמנט חדש**: `#matchesModal` - חלון קופץ (modal) להצגת ההקצאות
- **מבנה**:
  - `modal-header` - כותרת דינמית: "מי נוסע איתי?" / "איך אני נוסע?"
  - `modal-body` - תוכן דינמי של ההקצאות + **הסבר בראש**

##### הסבר במודל
בכל פתיחת מודל מופיע הסבר ירוק:
> 💡 **שים לב**: הנוסעים/ההצעות להלן הוקצו אוטומטית לנסיעה שלך.
> המידע מיועד לתיאום ישירות עם הנוסעים/הנהגים.

##### JavaScript
- **פונקציה**: `viewOfferMatches(offerId)` - שולפת ומציגה הקצאות להצעה
- **פונקציה**: `viewRequestMatches(requestId)` - שולפת ומציגה הקצאות לבקשה
- **פונקציה**: `displayMatchesModal(rideType, matches, type)` - מציגה את המודל עם הנתונים
- **פונקציה**: `closeMatchesModal()` - סוגרת את המודל
- **אירועים**:
  - לחיצה מחוץ למודל סוגרת אותו
  - מקש ESC סוגר את המודל

##### הצגת Match במודל

**עבור הצעת נסיעה (נהג רואה את הבקשות):**
- שם הנוסע
- טלפון
- כיוון נסיעה
- תאריך
- טווח שעות (מוקדם-מאוחר)
- נוסעים שהוקצו (מפורט לפי מין)
- הערות
- סטטוס השילוב

**עבור בקשת נסיעה (נוסע רואה את ההצעות):**
- שם הנהג
- טלפון
- כיוון נסיעה
- תאריך ושעת יציאה
- מקומות שהוקצו (מפורט לפי מין)
- סה"כ מקומות ברכב
- הערות
- סטטוס השילוב

##### סטטוסי Match
- `pending` - "ממתין"
- `notified` - "הודע"
- `connected` - "מחובר"
- `accepted` - "התקבל"
- `declined` - "נדחה"

## קבצים ששונו

1. **server/src/routes/offer-ride.js**
   - הוספת import של `getRequestById`
   - הוספת endpoint `GET /:id/matches` (שורות 650-747)

2. **server/src/routes/request-ride.js**
   - הוספת import של `getOfferById`
   - הוספת endpoint `GET /:id/matches` (שורות 840-937)

3. **server/public/my-rides.html**
   - הוספת CSS למודל ולנסיעות ישנות (שורות 237-381)
   - הוספת HTML של המודל (שורות 328-342)
   - הוספת פונקציות JavaScript:
     - `isPastRide()`, `isPastRequest()`
     - `viewOfferMatches()`, `viewRequestMatches()`
     - `displayMatchesModal()`, `closeMatchesModal()`
   - עדכון `renderOffers()` ו-`renderRequests()` לכלול סימון נסיעות ישנות וכפתור שילובים

## דוגמאות שימוש

### צפייה בהקצאות
1. משתמש נכנס לדף "הנסיעות שלי"
2. מזין מספר טלפון ולוחץ "הצג נסיעות"
3. לוחץ על "👥 מי נוסע איתי?" (נהג) או "🚗 איך אני נוסע?" (נוסע)
4. נפתח חלון עם הסבר שההקצאות כבר אושרו אוטומטית
5. רואה רשימת כל ההקצאות הפעילות והפרטים המלאים
6. יכול לסגור עם X, ESC, או לחיצה מחוץ לחלון

### זיהוי נסיעות ישנות
- נסיעות שעבר זמנן מופיעות באפור ומעומעמות
- תג הסטטוס משתנה ל"עבר זמנה"
- הזיהוי אוטומטי ומתבצע בזמן טעינת הנסיעות

## לוגיקת ההקצאות (חשוב!)

### איך המערכת מחליטה:
1. **נהג יוצר הצעה** �? המערכת מיד מחפשת בקשות מתאימות ו**יוצרת matches אוטומטית**
2. **נוסע יוצר בקשה** �? המערכת מיד מחפשת הצעות מתאימות ו**יוצרת matches אוטומטית**
3. **אין צורך באישור** משני הצדדים - ההחלטה של המערכת היא סופית

### כמה matches יכולים להיות?
- **נהג (הצעה)**: יכול להיות **מספר matches** - כל נוסע/משפחה שהוקצו למקומות שונים
- **נוסע (בקשה)**: בדרך כלל **match אחד** - אלא אם כן לא היו מספיק מקומות והמערכת **פיצלה** את הבקשה בין מספר הצעות

### סינון matches:
המערכת מציגה **רק** matches עם הסטטוסים הבאים:
- �? `pending` - ממתין לתקשורת
- �? `notified` - המערכת הודיעה למשתמשים
- �? xxxxxxcted` - המשתמשים דיברו בטלפון
- �? `accepted` - התקבל ואושר

**לא מציגה** matches עם:
- �? `declined` - נדחה
- �? `cancelled` - בוטל

## אבטחה

- כל endpoint בודק שמספר הטלפון תואם לבעלים של הנסיעה
- 403 Forbidden אם מנסים לראות matches של אחרים
- אימות קיום הנסיעה לפני שליפת המידע

## תאימות

- תומך בכל הדפדפנים המודרניים
- עיצוב רספונסיבי (מתאים לנייד)
- אנימציות CSS חלקות
- טיפול בשגיאות מקיף

## בדיקות מומלצות

1. ✅ יצירת הצעת/בקשת נסיעה חדשה
2. ✅ המתנה למערכת ליצור match אוטומטי
3. ✅ צפייה בהקצאות דרך הכפתור החדש
4. ✅ וידוא שההסבר מופיע בראש המודל
5. ✅ וידוא שרק matches פעילים מוצגים (לא declined/cancelled)
6. ✅ בדיקת נסיעה ישנה (ידנית או המתנה)
7. ✅ נסיון גישה ל-matches של משתמש אחר (צריך להיכשל)
8. ✅ סגירת מודל בכל השיטות (X, ESC, לחיצה חיצונית)
9. ✅ בדיקת טקסטים שונים לנהג ("מי נוסע איתי?") ולנוסע ("איך אני נוסע?")

