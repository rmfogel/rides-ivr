# מערכת טפסים אינטרנטיים להצעת ובקשת נסיעות

## מה נוסף למערכת

### ✅ Backend API (שלם!)

נוצרו 2 קבצי routes חדשים:

#### 1. **`server/src/routes/offer-ride.js`** - ניהול הצעות נסיעה
- `POST /api/rides/offer` - יצירת הצעה חדשה
- `GET /api/rides/offer?phone=XXX` - קבלת רשימת הצעות למשתמש
- `GET /api/rides/offer/:id?phone=XXX` - קבלת הצעה ספציפית
- `PUT /api/rides/offer/:id` - עדכון הצעה קיימת
- `DELETE /api/rides/offer/:id?phone=XXX` - ביטול הצעה

#### 2. **`server/src/routes/request-ride.js`** - ניהול בקשות נסיעה
- `POST /api/rides/request` - יצירת בקשה חדשה
- `GET /api/rides/request?phone=XXX` - קבלת רשימת בקשות למשתמש
- `GET /api/rides/request/:id?phone=XXX` - קבלת בקשה ספציפית
- `PUT /api/rides/request/:id` - עדכון בקשה קיימת
- `DELETE /api/rides/request/:id?phone=XXX` - ביטול בקשה

**תכונות:**
- ✅ אימות מלא של כל השדות (תאריכים, שעות, טלפון, מספרי נוסעים)
- ✅ בדיקה שהתאריך והשעה לא בעבר
- ✅ בדיקת בעלות - משתמש יכול לערוך/למחוק רק את הנסיעות שלו
- ✅ אינטגרציה מלאה עם מנוע ההתאמות הקיים
- ✅ החזרת התאמות מיידיות אחרי יצירת נסיעה
- ✅ טיפול מלא בשגיאות

### ✅ Frontend UI (שלם!)

#### 1. **`server/public/offer-ride.html`** - טופס הצעת נסיעה
שדות:
- מספר טלפון (חובה)
- כיוון נסיעה (FROM/TO)
- תאריך (חובה)
- שעת יציאה (חובה)
- סה"כ מקומות פנויים (חובה, 1-9)
- מקומות לגברים בלבד (אופציונלי)
- מקומות לנשים בלבד (אופציונלי)
- הערות (אופציונלי)

**תכונות:**
- ✅ אימות בצד הלקוח (client-side validation)
- ✅ בדיקה שמספר המקומות המיועדים לא עולה על הסה"כ
- ✅ עיצוב אחיד עם שאר המערכת
- ✅ הצגת הודעת הצלחה + מספר התאמות
- ✅ אפשרות למעבר ישיר לדף "הנסיעות שלי"

#### 2. **`server/public/request-ride.html`** - טופס בקשת נסיעה
שדות:
- מספר טלפון (חובה)
- כיוון נסיעה (FROM/TO)
- תאריך (חובה)
- שעה מוקדמת ביותר (חובה)
- שעה מאוחרת ביותר (חובה)
- שעה מועדפת (אופציונלי)
- מספר גברים, נשים, ילדים (אופציונלי)
- מספר זוגות (אופציונלי)
- האם כולם חייבים לנסוע ביחד (checkbox)
- הערות (אופציונלי)

**תכונות:**
- ✅ אימות בצד הלקוח
- ✅ בדיקה שהשעה המאוחרת אחרי השעה המוקדמת
- ✅ בדיקה שהשעה המועדפת בטווח
- ✅ חישוב אוטומטי של סה"כ נוסעים
- ✅ בדיקה שמספר הזוגות לא עולה על מספר המבוגרים/2
- ✅ הצגת סטטוס והתאמות

#### 3. **`server/public/my-rides.html`** - דף ניהול נסיעות
**תכונות:**
- ✅ הזנת מספר טלפון + טעינת כל הנסיעות
- ✅ הצגה נפרדת של הצעות (נהג) ובקשות (נוסע)
- ✅ הצגת כל הפרטים: תאריך, שעה, נוסעים, סטטוס
- ✅ כפתור מחיקה לכל נסיעה (עם אישור)
- ✅ מקום לכפתור עריכה (לעתיד)
- ✅ מסך ריק יפה עם קישור ליצירת נסיעה חדשה

#### 4. **`server/public/register.html`** - עדכון דף הרשמה
- ✅ הוספת תפריט ניווט לכל הדפים

### ✅ אינטגרציה (שלם!)

- ✅ שימוש בפונקציות `addOffer()` ו-`addRequest()` מ-`db/repo.js`
- ✅ הרצת `matchNewOffer()` ו-`matchNewRequest()` מ-`engine/matching.js`
- ✅ יצירת או שימוש במשתמש קיים דרך `getUserByPhone()` ו-`upsertUser()`
- ✅ החזרת התאמות מיידיות למשתמש

### ✅ אבטחה (שלם!)

- ✅ אימות מספר טלפון בכל בקשה
- ✅ בדיקת בעלות - משתמש יכול לערוך/למחוק רק נסיעות משלו (403 Forbidden)
- ✅ אימות שהמשתמש רשום במערכת (או יצירה אוטומטית)
- ✅ סינון query parameters למניעת SQL injection
- ✅ בדיקות תקינות על כל קלט

---

## כיצד להריץ

### 1. התקנת תלויות (אם לא הותקנו)
```powershell
cd server
npm install
```

### 2. הפעלת השרת
```powershell
cd server
npm start
# או
node start.js
```

### 3. גישה לדפים

- **דף הבית (הרשמה)**: http://localhost:3000/
- **הצעת נסיעה**: http://localhost:3000/offer-ride.html
- **בקשת נסיעה**: http://localhost:3000/request-ride.html
- **הנסיעות שלי**: http://localhost:3000/my-rides.html

---

## דוגמאות שימוש ב-API

### יצירת הצעת נסיעה
```bash
curl -X POST http://localhost:3000/api/rides/offer \
  -H "Content-Type: application/json" \
  -d '{
    "phone": "0501234567",
    "direction": "FROM",
    "date": "2025-11-05",
    "departureTime": "08:30",
    "totalSeats": 4,
    "maleOnlySeats": 0,
    "femaleOnlySeats": 0
  }'
```

### קבלת רשימת הצעות
```bash
curl "http://localhost:3000/api/rides/offer?phone=0501234567"
```

### מחיקת הצעה
```bash
curl -X DELETE "http://localhost:3000/api/rides/offer/OFFER_ID?phone=0501234567"
```

### יצירת בקשת נסיעה
```bash
curl -X POST http://localhost:3000/api/rides/request \
  -H "Content-Type: application/json" \
  -d '{
    "phone": "0509876543",
    "direction": "TO",
    "date": "2025-11-05",
    "earliestTime": "16:00",
    "latestTime": "18:00",
    "preferredTime": "17:00",
    "maleCount": 1,
    "femaleCount": 1,
    "childrenCount": 0,
    "couplesCount": 1,
    "together": true
  }'
```

---

## מה נשאר לעתיד (אופציונלי)

### שיפורים אפשריים:
1. **התראות SMS/Email** - שליחת התראה כשנמצאה התאמה
2. **עריכת נסיעה** - כרגע יש רק מחיקה, אפשר להוסיף modal לעריכה
3. **מערכת התחברות** - במקום להזין טלפון בכל פעם, לשמור ב-session/localStorage
4. **סינון וחיפוש** - בדף "הנסיעות שלי", הוספת אפשרות לסנן לפי תאריך/כיוון
5. **הצגת פרטי ההתאמה** - בדף הניהול, להציג את ההתאמות שנמצאו
6. **מפה** - הצגת מסלול הנסיעה על מפה
7. **דירוגים** - מערכת דירוגים לנהגים ונוסעים

---

## מבנה הקבצים שנוספו

```
server/
├── src/
│   └── routes/
│       ├── offer-ride.js          ← חדש!
│       └── request-ride.js        ← חדש!
└── public/
    ├── offer-ride.html            ← חדש!
    ├── request-ride.html          ← חדש!
    ├── my-rides.html              ← חדש!
    └── register.html              ← עודכן (הוספת ניווט)
```

---

## תכונות אבטחה

1. **אימות קלט**:
   - מספר טלפון: 10 ספרות בדיוק, מתחיל ב-0
   - תאריכים: לא בעבר
   - שעות: פורמט HH:mm, שעה מאוחרת > שעה מוקדמת
   - מספרים: בטווח הגיוני (0-9)

2. **בדיקת בעלות**:
   - כל endpoint של GET/PUT/DELETE בודק שהטלפון תואם למשתמש
   - החזרת 403 Forbidden אם לא

3. **טיפול בשגיאות**:
   - כל שגיאת שרת מתועדת ב-logger
   - החזרת הודעות שגיאה ברורות למשתמש
   - catch על כל פעולות DB

---

## סיכום

המערכת מוכנה ופועלת! 🎉

כל הקוד כתוב עם:
- ✅ אימות תקינות מלא
- ✅ טיפול בשגיאות מקיף
- ✅ אבטחה בסיסית (בדיקת בעלות)
- ✅ אינטגרציה עם המערכת הקיימת
- ✅ עיצוב אחיד ומקצועי
- ✅ תמיכה במובייל (responsive)

אפשר להתחיל להשתמש מיד! 🚀
