# אפיון מערכת IVR לתיאום נסיעות בקהילה סגורה (Twilio)

תאריך: 2025-09-15
אזור זמן מערכת: Asia/Jerusalem (שמירה בבסיס נתונים ב-UTC)

תקציר
- מערכת קולית (IVR) סגורה ללא הודעות טקסט. התראות מבוססות “צינתוק” בלבד.
- זיהוי מספר מול רשימת מורשים. תפריטי DTMF בעברית.
- נהג מפרסם נסיעה עם תאריך, שעת יציאה, כיוון, ופריסת מושבים: לגברים/לנשים/לשני המגדרים.
- נוסע יוצר בקשה: תאריך, חלון זמנים, פירוט נוסעים (זוגות/בודדים גברים/נשים), “קריטי ביחד” או מותר פיצול.
- התאמה על בסיס FIFO של בקשות (created_at), התאמות מוצגות לנוסע כשחוזר לקו לאחר צינתוק. ניתן לגשר לשיחה עם הנהג או לשמוע מספר ספרה-ספרה.
- תמיכה ב”זוגות”: יושבים יחד באותו רכב; מגדר הזוג לא מגביל. אין קדימות לזוגות.
- together=false: מותר פיצול בין יותר משני נהגים. together=true: חייב נהג אחד.

מושגים
- כיוון: FROM = יוצא מהיישוב, TO = לכיוון היישוב.
- מושבים: male_only, female_only, anygender.
- בקשה: passengers_total, couples_count, single_males, single_females, together.
- צינתוק: שיחה יוצאת קצרה לנוסע (רינג קצר, ניתוק), כדי לסמן שנמצאה התאמה.

מטרות עיקריות
- חיבור נהגים ונוסעים ב-IVR בלבד.
- צמצום זמן שיחה ועלויות באמצעות צינתוק והתנהלות pull (הנוסע חוזר לקו לשמוע התאמות).
- שמירה על פרטיות ואבטחה בקהילה סגורה.

תחום
- בתוך הקהילה בלבד; בלי הודעות SMS/WhatsApp.
- ממשק מנהל בסיסי (קולי או ממשק ניהול) לניהול מורשים, שמות וניקוי נתונים.

## מבנה זרימות IVR

1) שיחה נכנסת – זיהוי והרשאה
- זיהוי לפי Caller ID מול Users.is_allowed.
- לא מורשה: “מספר לא מורשה. לפנייה לאדמין הקישו 9” → ניתוק.
- אם קיימות התאמות ממתינות לנוסע: תפריט “התאמות ממתינות” לפני התפריט הראשי.

2) התאמות ממתינות לנוסע
- “נמצאו X התאמות.”
  - 1 התאמה הקרובה בזמן
  - 2 מעבר להתאמה הבאה
  - 3 חזרה לתפריט הראשי
- בפרטי התאמה: שעה, כיוון, שם הנהג (אם הוסמך לשיתוף), הערכה אם הבקשה מלאה/חלקית.
  - 1 להתחבר לנהג כעת (Dial עם מספר חיץ אופציונלי)
  - 2 לשמוע מספר הנהג ספרה-ספרה
  - 9 חזרה
- לאחר ניתוק משיחת הגישור:
  - “האם הנסיעה סוכמה?” 1 כן → עדכון אישור והתפסת מושבים; 2 לא → שחרור ההקצאה לאחר TTL.

3) תפריט ראשי
- 1 אני נהג
- 2 אני נוסע
- 3 ניהול הפריטים שלי (ביטול/עדכון שם/הגדרות)
- 9 סיום

4) נהג – פרסום נסיעה
- בדיקת declared_gender בפרופיל:
  - אם חסר: “לשמירת מגדר: לגבר הקישו 1, לאישה 2.” (חובה לנהג)
- קבלת פרטי נסיעה:
  - תאריך: 1 היום, 2 מחר, 3 תאריך אחר (DDMMYY)
  - שעה: HHMM (ארבע ספרות)
  - כיוון: 1 יוצא מהיישוב, 2 לכיוון היישוב
  - מושבים:
    - מקומות לגברים בלבד (0–9)
    - מקומות לנשים בלבד (0–9)
    - מקומות לשני המגדרים (0–9)
- הקראה לאישור. 1 שמירה; 2 עריכה.
- ניסיון התאמה מיידי מול בקשות פתוחות. על התאמות רלוונטיות: צינתוק לנוסעים.

5) נוסע – יצירת בקשה
- תאריך: 1 היום, 2 מחר, 3 תאריך אחר (DDMMYY)
- חלון זמנים: שעה מוקדמת HHMM, שעה מאוחרת HHMM
- כיוון: 1 יוצא מהיישוב, 2 לכיוון היישוב
- פירוט נוסעים:
  - מספר נוסעים כולל
  - כמה זוגות (0..floor(total/2))
  - כמה גברים בודדים
  - כמה נשים בודדות
  - ולידציה: couples*2 + singles_m + singles_f = total
- קריטי ביחד? 1 כן (together=true), 2 לא (together=false)
- אישור ושמירה. מערכת תנסה התאמה; על התאמה/ות: צינתוק לנוסע.

6) ניהול
- 1 ביטול בקשה/הצעה פעילה שלי
- 2 עדכון שם להצגה בהקראה
- 3 עדכון מגדר פרופיל (נהגים בלבד)
- 9 חזרה

## כללי התאמה וקדימויות

כללי בסיס
- כיוון חייב להתאים.
- זמן: departure_time ∈ [earliest_time, latest_time] של הבקשה.
- זוגות: חייבים לשבת יחד באותו רכב; מגדר הזוג לא מגביל.
- אין קדימות לזוגות ביחס ליחידים.

קדימויות
- עיבוד בקשות FIFO לפי RideRequests.created_at ASC.
- עבור בקשה בודדת:
  - מיין הצעות פעילות לפי departure_time ASC בתוך החלון, ואז RideOffers.created_at ASC.
- together=true: חפש נהג יחיד שמכסה את כל הצורך. אם אין – אין התאמה.
- together=false: מותר פיצול בין כל מספר נהגים. יעד משני: למזער מספר נהגים, אך לא על חשבון FIFO של הבקשות.

כללי הקצאת מושבים (לפי רכב/הצעה אחת)
- יחיד גבר: קודם male_only, אחרת anygender.
- יחידה אישה: קודם female_only, אחרת anygender.
- זוג: סדר נסיון:
  1) מושב male_only + מושב female_only (אם זמינים)
  2) שני מושבי anygender
  3) שני מושבים מאותו מגדר (male_only*2 או female_only*2) – רק אם מדיניות הקהילה מאפשרת. ברירת מחדל: לא.
- ניטרליות: אין קדימות לזוגות; ההקצאה יכולה להיות בסבב מאוזן בין יחידות (זוג/גבר/אישה) כדי למנוע נעילת גמישות.

## החזקת מושבים ונעילות
- יצירת Match יוצרת hold על מושבים ל-5 דקות (status=pending/notified).
- אם אין “מחובר/מאושר” בזמן ה-TTL, שחרור אוטומטי.

## התראות (קול בלבד)
- על יצירת התאמה חדשה/חלקית: מערכת מבצעת צינתוק לנוסע (רינג קצר, ניתוק).
- כשהנוסע מתקשר בחזרה: שומע התאמות ממתינות, יכול לגשר לנהגים אחד-אחד.
- מגבלת קצב צינתוקים: לדוגמה עד 2 בכל 15 דק’ לכל מספר; ניסיונות ב-3 ו-10 דקות.

## תאריכים וזמנים
- קלט תאריכים: היום/מחר/תאריך אחר (DDMMYY).
- קלט שעה: HHMM ארבע ספרות.
- אחסון: TIMESTAMPTZ ב-UTC. פרשנות ואימות ב-Asia/Jerusalem.
- איסור חלון חוצה-תאריך: earliest ≤ latest באותו יום נבחר.

## מחזור חיים ו-TTL
- הצעת נהג: פגה ב-departure_time + 30 דקות או במיצוי מושבים (status=expired/filled).
- בקשת נוסע: פגה ב-latest_time + 15 דקות או בביטול/מילוי מלא.
- Match: pending/notified ללא פעולה פג אחרי 15 דקות.

## אבטחה ופרטיות
- אימות חתימת Twilio לכל וובהוק (X-Twilio-Signature).
- רשימת מורשים: Users.is_allowed = true בלבד מקבלים שירות.
- מניעת דליפת מספרים:
  - גישור עם מספר חיץ (Twilio) מומלץ; או הקראת מספר ספרה-ספרה לפי מדיניות.
- Rate limiting לפי מספר טלפון ושיוכי חשבון.
- הצפנת נתונים במעבר (HTTPS) ובמנוחה (DB-level encryption/at-rest).
- מינימום שמירת PII (שם, טלפון, חיווי מגדר מוצהר לנהג בלבד).
- לוגים מסוננים: ללא הקלטה של נתוני DTMF המייצגים מידע רגיש מעבר לנדרש.

## טיפול בשגיאות וחוויית משתמש
- קלט לא תקין (תאריך/שעה/מספרים): עד 2 ניסיונות → הודעת שגיאה וסיום/חזרה לתפריט.
- סתירות מספריות:
  - couples*2 > total → בקשת תיקון.
  - singles_m + singles_f != total - couples*2 → בקשת תיקון.
- חלון זמנים הפוך → בקשת תיקון.
- אי-מענה בשיחת גישור: הצעת ריטריי או שמירת התאמה ממתינה; שחרור hold לאחר TTL.
- עומס/שגיאת שרת: הודעת “תקלה זמנית” וניתוק אדיב.
- חסימת שימוש חריג: הודעה “חרגת ממספר הפעולות המותר”.

## ניטור, תצפיות ותפעול
- Metrics: מספר בקשות/הצעות פעילות, שיעור התאמות, זמני המתנה, שיעור גישור מוצלח, דחיות, כשלי שיחה יוצאת.
- לוגים: אירועי IVR, יצירה/עדכון/ביטול ישויות, שגיאות וובהוקים.
- התראות תפעוליות: כשלי וובהוק/שיחות → מייל/טלגרם לאדמין.
- משימות רקע: ניקוי רשומות פגות, שחרור hold, ריצת matching עבור בקשות חדשות/מעודכנות.

## סכימת נתונים מוצעת (PostgreSQL)
- Users(id, phone unique, name, is_allowed, declared_gender ENUM('male','female') NULL, created_at, updated_at)
- RideOffers(id, driver_phone FK Users.phone, direction ENUM('FROM','TO'), departure_time timestamptz, seats_male_only int, seats_female_only int, seats_anygender int, status ENUM('active','expired','cancelled','filled'), created_at, expires_at)
- RideRequests(id, rider_phone FK Users.phone, direction ENUM('FROM','TO'), request_date date (נגזר), earliest_time timestamptz, latest_time timestamptz, passengers_total int, couples_count int, passengers_male int, passengers_female int, together boolean, status ENUM('open','partial','matched','expired','cancelled'), created_at, expires_at)
- Matches(id, offer_id FK, request_id FK, allocated_couples int, allocated_male int, allocated_female int, allocated_anygender int, status ENUM('pending','notified','connected','confirmed','declined','expired'), notified_via ENUM('ringback'), hold_expires_at timestamptz, created_at, updated_at)
- אינדקסים: לפי סטטוס+זמן לשאילתות מהירות.

## ממשקי שרת ווובהוקים (Node/Express לדוגמה)
- POST /voice/incoming – נקודת כניסה לשיחה; TwiML עם <Gather> לעברית (Voice Polly.Carmel).
- POST /voice/menu – תפריטים: נהג/נוסע/ניהול/התאמות ממתינות.
- POST /voice/driver – זרימה לקליטת נסיעה.
- POST /voice/rider – זרימה לקליטת בקשה.
- POST /voice/pending – קריאת התאמות ממתינות ו-Dial לנהג.
- POST /voice/dial-status – סטטוס גישור; עדכון Match (connected/declined).
- POST /events/match – טריגר התאמה/ריצת אלגוריתם לאחר שינוי ישויות.
- POST /calls/ringback – ייזום צינתוק לנוסע.
- אימות חתימה לכל הכתובות; החזרת TwiML תקין או 4xx/5xx בהתאם.

## TwiML – עקרונות
- שימוש ב-<Gather input="dtmf" timeout="5" numDigits="..."> והקראה בעברית.
- <Say voice="Polly.Carmel"> עבור TTS.
- <Dial callerId="מספר חיץ"> לגישור לנהג.
- הקראת מספר ספרה-ספרה עם <Say> מרווחים קצרים.

## אלגוריתם התאמה (תמצית)
1) משימת רקע או טריגר:
   - שלוף בקשות status ∈ (open, partial) לפי created_at ASC.
2) לכל בקשה:
   - שלוף הצעות פעילות בכיוון תואם, departure_time ∈ [earliest, latest], תאריך תואם.
   - מיין לפי departure_time ASC ואז created_at ASC.
   - together=true: נסה הקצאה מלאה מרכב יחיד לפי כללי המושבים (כולל זוגות).
   - together=false: בצע הקצאה הדרגתית מרכבים מרובים עד כיסוי מלא; שמור יעד משני למזער מספר נהגים תוך שמירה על סדר המיון.
   - צור Matches עם hold_expires_at = now()+5 דק’ לכל הקצאה חדשה/חלקית.
   - ייזום צינתוק לנוסע עבור התאמות/השלמות חדשות.
3) שחרור hold אוטומטי אם לא אושר/חובר עד hold_expires_at.

## ולידציות עסקיות
- נהג ללא declared_gender → חסימה מפרסום.
- נהג: לפחות מושב אחד > 0.
- נוסע: couples*2 + singles_m + singles_f = total; total > 0.
- חלון זמנים תקין; מועד עתידי או היום; ללא חציית יום.
- התאמה זוג במושבי מגדר-זהה כפול – רק אם מאושר במדיניות.

## פרטיות וציות
- שמירת נתונים מזערית ולמשך זמן קצוב (TTL 14–30 ימים).
- חשיפה מינימלית של שם/מספר נהג לפי הסכמה.
- תיעוד הסכמות והודעות פרטיות קהילתיות.

## שלבי ביצוע (Roadmap)

שלב 1 – MVP
- תשתית וובהוקים עם אימות חתימה.
- תפריט בסיסי: נהג/נוסע/ניהול.
- קליטת נהג: תאריך, שעה, כיוון, מושבים; שמירה.
- קליטת נוסע: תאריך, חלון, פירוט נוסעים, together; שמירה.
- אלגוריתם התאמה בסיסי + יצירת Matches והחזקת מושבים.
- צינתוק לנוסעים; מסך “התאמות ממתינות” + גישור לנהג.
- ניקוי TTL בסיסי; לוגים ומדדים ראשוניים.

שלב 2 – ייצוב ופונקציות ניהול
- ביטולים/עדכונים מה- IVR.
- דוחות תפעוליים בסיסיים.
- מגבלות קצב לצינתוקים וחיבורים.
- חוויית שגיאות מוקפדת + הקלטות באיכות גבוהה/Polly.

שלב 3 – פרטיות וחיץ
- גישור עם מספר חיץ כברירת מחדל.
- מדיניות שימוש בזוג עם שני מושבים מגדר-זהה (דגל קהילה).
- שיפורי אלגוריתם למזעור מספר הנהגים כשמותר פיצול.

שלב 4 – ניטור וסקייל
- דשבורד תצפיות מלא, התראות שגיאה.
- אופטימיזציות DB ואינדקסים.
- מבחני עומס והקשחת עמידות.

## בדיקות וקבלה
- יחידה: ולידציות קלט DTMF, פרשנות תאריך/שעה, הקצאות מושבים.
- אינטגרציה: זרימות IVR מלאות, יצירת/שחרור hold, גישור, סטטוס שיחה.
- E2E: נהג מפרסם ← נוסע מבקש ← צינתוק ← חזרה לקו ← גישור ← אישור.
- מקרי קצה: אי-מענה, חלון לא תקין, חוסר מושבים, פיצול בין >2 נהגים, עומסים.

## סיכונים והנחות
- צינתוק עשוי להיות מחויב בעלות קצרה מצד הספק; יש לתקצב.
- זיהוי Caller ID אמין; מספרים חסויים לא נתמכים.
- TTS בעברית (Polly Carmel) זמין בחשבון Twilio.

## שאלות פתוחות
- שימוש במספר חיץ חובה או אופציונלי?
- מדיניות קהילה לשימוש בזוג עם שני מושבים מאותו מגדר?
- מגבלות קצב מדויקות לצינתוקים ולגישורים?
